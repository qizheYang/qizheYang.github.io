<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects - Qizhe Yang</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Fixed Header -->
<header>
    <nav>
        <a href="index.html">Home</a>
        <a href="cv.pdf" target="_blank">CV</a>
        <a href="projects.html">Projects</a>
        <a href="skills_and_portfolio.html">Skills</a>
        <a href="additional_interests.html">Other Interests</a>
        <a href="index-cn.html">中文</a>
    </nav>
</header>

<!-- Layout -->
<div class="layout">
    <!-- Left Island: TOC -->
    <aside class="toc">
        <h2>Contents</h2>
        <ul>
            <li><a href="#" data-proj="proj1">Shadow Walker The Huntington</a></li>
            <li><a href="#" data-proj="proj2">Group Travel Planner</a></li>
            <li><a href="#" data-proj="proj3">Latin-Chinese Translation</a></li>
            <li><a href="#" data-proj="proj4">Bristled Wings Robotic Fly</a></li>
            <li><a href="#" data-proj="proj5">PFAS Research</a></li>
            <li><a href="#" data-proj="proj6">USC Formula E</a></li>
        </ul>
    </aside>

    <!-- Main Island -->
    <div class="main-content" id="mainContent">
        <h1>Projects</h1>
        <p>Select a project from the menu to view details.</p>
    </div>
</div>

<!-- Fixed Footer -->
<div class="footer-bar">
    <a href="logo_display.html" target="_blank">
        <img src="img/yqz_logo.svg" alt="Qizhe Yang Logo">
    </a>
    <span>
    Hosted on <a href="https://github.com/qizheYang/qizheYang.github.io" target="_blank">GitHub Pages</a>
    &nbsp; | &nbsp; &copy; 2025 Qizhe Yang
  </span>
</div>

<script>
    // Project data
    const projectDetails = {
        proj1: {
            title: "Shadow Walker – The Huntington",
            desc: `<p>Shadow Walker is an interactive Web Application built using Python (Flask) and HTML/CSS/JavaScript. It features:</p>
                <ul>
                    <li>Dynamic A* pathfinding with shade-aware cost function</li>
                    <li>Shade maps from <a href="https://shademap.app" target="_blank">ShadeMap</a> processed with computer vision</li>
                    <li>Interactive UI with zoomable map, compass, customizable POIs</li>
                    <li>Integration with OpenWeatherAPI for real-time weather</li>
                    <li>Desktop and mobile versions available</li>
                </ul> <br>
                <p>
                    For more information, and full opensource code,
                    please visit <a href="https://github.com/qizheYang/ShadowWalkerTheHuntington">GitHub Repo</a>
                    or to access the web app, visit <a href="https://walkhuntington.yangqizhe.com" target="_blank">WalkHuntington</a>
                    which is deployed at PythonAnywhere.
                </p>`,
            code: `
# app.py including main functions
from flask import Flask, render_template, request, jsonify, send_from_directory
import numpy as np
import heapq
import requests
import datetime
import shade_utils
import json
import os

app = Flask(__name__)

OPENWEATHER_API_KEY = "9ad163a00f70fb040a97016d7d0bc042"

walkability_map = np.loadtxt("walkability_map.txt", dtype=int)
height, width = walkability_map.shape

def astar(start, goal, grid):
    def heuristic(a, b):
        return abs(a[0] - b[0]) + abs(a[1] - b[1])

    # === Use 8 neighbors ===
    neighbors = [(-1,0), (1,0), (0,-1), (0,1), (-1,-1), (-1,1), (1,-1), (1,1)]

    open_set = []
    heapq.heappush(open_set, (0, start))
    came_from = {}
    g_score = {start: 0}
    f_score = {start: heuristic(start, goal)}

    while open_set:
        current = heapq.heappop(open_set)[1]

        if current == goal:
            path = []
            while current in came_from:
                path.append(current)
                current = came_from[current]
            path.append(start)
            path.reverse()
            return path

        for dx, dy in neighbors:
            neighbor = (current[0] + dx, current[1] + dy)
            if 0 <= neighbor[0] < height and 0 <= neighbor[1] < width:
                cell_value = grid[neighbor]

                if cell_value == 1:
                    step_cost = 3
                else:
                    step_cost = 10000

                if step_cost >= 10000:
                    continue

                tentative_g = g_score[current] + step_cost

                if neighbor not in g_score or tentative_g < g_score[neighbor]:
                    came_from[neighbor] = current
                    g_score[neighbor] = tentative_g
                    f_score[neighbor] = tentative_g + heuristic(neighbor, goal)
                    heapq.heappush(open_set, (f_score[neighbor], neighbor))

    return []

def find_nearest_white(point, grid):
    from collections import deque
    queue = deque()
    visited = set()
    queue.append((point[0], point[1], 0))

    while queue:
        x, y, dist = queue.popleft()
        if (x, y) in visited:
            continue
        visited.add((x, y))

        if 0 <= x < height and 0 <= y < width:
            if grid[x, y] == 1:
                return (x, y)
            for dx, dy in [(-1,0), (1,0), (0,-1), (0,1)]:
                queue.append((x + dx, y + dy, dist + 1))
    return point

@app.route("/")
def index():
    return render_template("index.html", width=width, height=height)

@app.route("/path", methods=["POST"])
def path():
    data = request.json
    start = (data["start"]["y"], data["start"]["x"])
    end = (data["end"]["y"], data["end"]["x"])

    use_shade = data.get("use_shade", False)
    print(f"[INFO] Path request: use_shade={use_shade}")

    start = find_nearest_white(start, walkability_map)
    end = find_nearest_white(end, walkability_map)

    if use_shade:
        grid = shade_utils.get_combined_map(walkability_map)
        path_result = shade_utils.astar_with_shade(start, end, grid)
    else:
        grid = walkability_map
        path_result = astar(start, end, grid)

    path_xy = [{"x": p[1], "y": p[0]} for p in path_result]

    return jsonify({"path": path_xy})

@app.route("/weather")
def weather():
    url = f"https://api.openweathermap.org/data/2.5/forecast?lat=34.128&lon=-118.114&units=metric&appid={OPENWEATHER_API_KEY}"

    response = requests.get(url)

    if "application/json" in response.headers.get("Content-Type", ""):
        data = response.json()
        now = datetime.datetime.now()
        today_date = now.date()

        today_forecast = []
        for item in data["list"]:
            dt = datetime.datetime.fromtimestamp(item["dt"])
            if dt.date() == today_date and dt.hour >= now.hour:
                entry = {
                    "dt": item["dt"],
                    "temp": item["main"]["temp"],
                    "humidity": item["main"]["humidity"],
                    "wind_speed": item["wind"]["speed"],
                    "wind_deg": item["wind"]["deg"],
                    "weather": item["weather"][0]["description"]
                }
                today_forecast.append(entry)

        return jsonify({"hourly": today_forecast})
    else:
        return jsonify({"error": "Failed to fetch weather data"}), 500

@app.route('/pois.json')
def serve_pois():
    return jsonify(adjusted_pois)

@app.route('/shade_png/<path:filename>')
def serve_shade_png(filename):
    return send_from_directory('shade_png', filename)

@app.route('/shade_txt/<path:filename>')
def serve_shade_txt(filename):
    return send_from_directory('shade_txt', filename)

@app.route('/walkability')
def serve_walkability():
    return jsonify(walkability_map.tolist())

@app.route("/mobile.html")
def mobile():
    return render_template("mobile.html", width=width, height=height)

# === Preprocess POIs ===
POIS_PATH = os.path.join('static', 'pois.json')
adjusted_pois = []

if os.path.exists(POIS_PATH):
    with open(POIS_PATH, 'r', encoding='utf-8') as f:
        original_pois = json.load(f)

    for poi in original_pois:
        name = poi.get('name', 'Unknown')
        coord = poi.get('coord', [0, 0])
        y, x = coord[1], coord[0]

        if 0 <= y < height and 0 <= x < width:
            if walkability_map[y, x] != 1:
                new_y, new_x = find_nearest_white((y, x), walkability_map)
                print(f"[INFO] Adjusting POI '{name}': ({x},{y}) → ({new_x},{new_y})")
                adjusted_coord = [new_x, new_y]
            else:
                adjusted_coord = [x, y]
        else:
            print(f"[WARNING] POI '{name}' out of bounds: ({x},{y}) — skipped")
            continue

        adjusted_pois.append({
            'name': name,
            'coord': adjusted_coord
        })

    print(f"[INFO] Loaded and adjusted {len(adjusted_pois)} POIs.")
else:
    print(f"[ERROR] POI file not found: {POIS_PATH}")

if __name__ == "__main__":
    # app.run(debug=True)
    app.run(host='0.0.0.0', port=5000)
            `
        },

        proj2: {
            title: "Group Travel Planner",
            desc: `<p>
From the original proposal: <br> A group travel planner web app (optimized for Chrome) that features a shared workspace system that allows friends to construct/create travel proposals/plans through a common editing environment (appears as blocks). It will include real-time weather forecasts along with flight and hotel pricing, and will appear within the app. Additionally, it will accept user-input about locations and dates, while also having the ability to add/suggest alternatives. A live poll and multithreading enables users to participate in the selection of travel plans by voting for proposed changes during evaluations as well as which final proposal they would like.
For opensource code, please visit <a href="https://github.com/Daniel0701/CSCI201-Final-Project">GitHub Repo</a> and deploy on Tomcat. <br> <br>
Originally for this project, I also wrote API connections with OpenWeather, hotels4.p.rapidapi.com OpenCageData, and Booking.com.
</p>`,
            code: `
// automatic testing suite for API connections written by me
package tss;

import static org.junit.jupiter.api.Assertions.*;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import weatherAPI.*;
import hotelAPI.*;
import flightAPI.*;

import java.time.LocalDate;
import java.util.List;

/**
 * Tests for WeatherAPI, HotelAPI, and FlightAPI
 * Covers: Unit, White-box, Black-box, Regression, Integration tests
 */
public class APITest {

    private static WeatherAPI weatherAPI;
    private static HotelAPI hotelAPI;
    private static FlightAPI flightAPI;

    @BeforeAll
    static void setup() {
        weatherAPI = new OpenWeatherAPI();
        hotelAPI = new RapidAPI();
        flightAPI = new BookingAPI();
    }

    @Test
    void testGetWeatherValidCity() {
        WeatherData data = weatherAPI.getWeather("Tokyo", LocalDate.now());
        assertNotNull(data, "WeatherData should not be null");
        assertTrue(data.getTemperature() > -100 && data.getTemperature() < 100, "Temperature should be realistic");
        assertNotNull(data.getCondition(), "Condition should not be null");
    }

    @Test
    void testGetWeatherInvalidCity() {
        WeatherData data = weatherAPI.getWeather("InvalidCityNameXYZ", LocalDate.now());
        assertNotNull(data, "WeatherData should not be null even for invalid city");
        assertEquals("Unavailable", data.getCondition(), "Condition should be 'Unavailable' for bad city");
    }

    @Test
    void testGetHotelsValidCity() {
        List<HotelData> hotels = hotelAPI.getHotels("Los Angeles", "2025-06-01", "2025-06-03");
        assertNotNull(hotels, "Hotels list should not be null");
        assertFalse(hotels.isEmpty(), "Hotels list should not be empty for valid city");
        for (HotelData hotel : hotels) {
            assertNotNull(hotel.getHotelName(), "Hotel name should not be null");
            assertTrue(hotel.getLowestRoomRate() > 0, "Hotel rate should be positive");
        }
    }

    @Test
    void testGetHotelsInvalidCity() {
        List<HotelData> hotels = hotelAPI.getHotels("FakeCityXYZ", "2025-06-01", "2025-06-03");
        assertNotNull(hotels, "Hotels list should not be null even for invalid city");
        assertTrue(hotels.isEmpty(), "Hotels list should be empty for invalid city");
    }

    @Test
    void testGetFlightsValidRoute() {
        List<FlightData> flights = flightAPI.getFlights("LAX", "JFK", "2025-06-01");
        assertNotNull(flights, "Flights list should not be null");
        assertFalse(flights.isEmpty(), "Flights list should not be empty for valid route");
        for (FlightData flight : flights) {
            assertNotNull(flight.getAirline(), "Airline name should not be null");
            assertTrue(flight.getPrice() > 0, "Flight price should be positive");
            assertNotNull(flight.getFlightNumber(), "Flight number should not be null");
        }
    }

    @Test
    void testGetFlightsInvalidRoute() {
        List<FlightData> flights = flightAPI.getFlights("XXX", "YYY", "2025-06-01");
        assertNotNull(flights, "Flights list should not be null even for invalid route");
        assertTrue(flights.isEmpty(), "Flights list should be empty for invalid route");
    }

    @Test
    void testIntegrationWeatherHotelFlight() {
        String city = "Paris";
        String checkIn = "2025-07-01";
        String checkOut = "2025-07-03";

        WeatherData weather = weatherAPI.getWeather(city, LocalDate.parse(checkIn));
        List<HotelData> hotels = hotelAPI.getHotels(city, checkIn, checkOut);
        List<FlightData> flights = flightAPI.getFlights("LAX", "CDG", checkIn); // CDG = Paris airport

        assertNotNull(weather, "Weather should not be null");
        assertTrue(weather.getCondition() != null, "Weather condition should be valid");

        assertNotNull(hotels, "Hotels should not be null");
        assertFalse(hotels.isEmpty(), "Hotels should not be empty for Paris");

        assertNotNull(flights, "Flights should not be null");
        assertFalse(flights.isEmpty(), "Flights should not be empty for Paris route");
    }

    @Test
    void testWeatherAPIRegression() {
        WeatherData data = weatherAPI.getWeather("Seoul", LocalDate.now());
        assertNotNull(data, "WeatherData should still work after updates");
        assertNotNull(data.getCondition(), "Weather condition should still be retrievable");
    }

    @Test
    void testHotelAPIRegression() {
        List<HotelData> hotels = hotelAPI.getHotels("New York", "2025-08-01", "2025-08-03");
        assertNotNull(hotels, "Hotels should still be fetched after code updates");
    }

    @Test
    void testFlightAPIRegression() {
        List<FlightData> flights = flightAPI.getFlights("SFO", "LHR", "2025-08-01");
        assertNotNull(flights, "Flights should still be fetched correctly after code updates");
    }
}
            `
        },

        proj3: {
            title: "Latin-Chinese Translation",
            desc: `<p>
                    With professors <a href="https://dornsife.usc.edu/profile/lucas-herchenroeder/">Dr. Lucas Herchenroeder<a>
                    and <a href="https://dornsife.usc.edu/profile/stefano-rebeggiani/">Dr. Stefano Rebeggiani</a> and two friends,
                    translated the masterpiece of Martino Martini, a 17th Century Jesuit missionary who traveled to China twice,
                    On Friendship 逑友篇 from classical Chinese to modern English. For detailed information,
                    visit <a href="https://charm.havencreative.org/chinese-latin-translation/">Official Website</a>.
            </p>`,
            code: `
Excerpt
Chapter 1: The Difficulty of Obtaining a True Friend
Ft. Yihao Fan, Sihan Lyu, Qizhe Yang

Friendship is the hardest to swim among all oceans of love.
When the waves are calm, a boat travels deep into the ocean.
But when a furious wind suddenly rises, and waves surge,
one then constantly worries about the boat being overthrown and being drowned.
The sea is ever- changing., As a result, sailors are cautious and always on
the alert for danger.
So are those who cross the oceans of love. One must probe the depths of heart,
as well as make trial of good and evil appearances.
There are in this world people who show a loving and kind demeanor
on the outside and hide hatred and ill will within;
and have bellies in contradiction with their mouths.
If one obtains an upright and virtuous friend and
this person saves him from trouble in a time of crisis in addition to
looking out more for him when he is doing well for himself,
isn’t it the case that he will benefit exceedingly well?
If one meets with a perilous situation,
he is in danger.  When harm comes and a person’s animosity is apparent,
one can protect himself from harm.
This is because one then knows the ill intent of that person,
and by identifying an enemy one can avoid danger.
Those acquaintances who are exceptionally deceitful and insincere put on
flattering appearances and make a display
of their friends and cultivate reputation,
while in reality they veil their animosity.
They devise complicated measures to trap people,
and once someone is trapped and the mechanism triggered,
they immediately spit poison from their belly and entrails.
More to the point, virtuous people who are all-embracing in their tolerance
will face greater danger if they befriend that kind of person,
for the virtuous people is honest and straight-minded;
they are not prone to be even the least suspicious towards others.
They think of their friends in the image of themselves and
regard it as fitting to treat them in this way.
They do not believe there to be false friends who would deceive them,
and so never use trickery against trickery to defend themselves.
As a result, they are harmed even more by dissemblers.
Furthermore, they yield to none,
and act always in accordance with a high moral standard.
They do not believe that others would act in deceit,
since they themselves would not do so.
They are unaware of traps that they themselves would never set up,
and which would allow them to guard against such deception —
they hence are made more vulnerable.
     `
        },

        proj4: {
            title: "Bristled Wings Robotic Fly",
            desc: `<p>
A newly starting project with my friends in designing a bionic robot featuring <a href="https://www.pnas.org/doi/10.1073/pnas.2506403122">Bristled Wings</a>
in replacement of more common membrane wings. It is still a work in progress, but should feature computer vision and machine learning based automatic
routing system that this robotic fly should find plates and bowls to fly to.

</p>`
        },
        proj5: {
            title: "PFAS Research",
            desc: `<p>
An environmentally concerning person I am, collaborated with Professor <a href="https://viterbi.usc.edu/directory/faculty/Pirbazari/Massoud">Dr. Massoud Pirbazari (Dr. P)</a>
of USC Viterbi Department of Civil and Environmental Engineering on a project in researching methodology of removal of PFAS from water and air. This project is part of the
<a href="https://cee.usc.edu/research/water-quality-research-group/swan/">Safe Water for All Nations (S.W.A.N.)</a> lab.

</p>`

        },
        proj6: {
            title: "USC Formula E",
            desc: `<p>
                Designed the interface of dashboard; coded for all dashboard.ino using Arduino C++; debugged and maintained code in our GEVCU.
                Worked with teammates, a proof of teamwork-ability.
                Devised tests and tested all connections between dashboard, GEVCU control, motor controllers and cooling systems.
                Please visit <a href="https://github.com/SCFormulaElectric/dashboard_2024-2025">Dashboard</a> and <a href="https://github.com/SCFormulaElectric/gevcu-2024-2025">GEVCU</a>
                to see our opensource code and my contributions.
            </p>`,
            code: `
/*
  This is the ULTIMATE program for Teensy.
  Teensy is the communicator between GEVCU and Nextion Display.
  Teensy is connected to the display using RX/TX, pin 8 and 7 respectively.
  When connecting Teensy and display, connect Teensy RX to display TX and vice versa.
  Teensy is connected to the GEVCU using CAN bridge.
  Please refer to Systems Electric for CANBUS.
*/

// #include <FlexCAN.h>
#include <FlexCAN_T4.h>
/*
  12/02/24 Need to handle receive messages from can to update the dashboard
  01/27/25 Fixed the serial port issue. Tested RX/TX com with Nextion Display.
  - Need testings on CAN with GEVCU and BMS
  04/28/25 Migrated reading speed, motor temp, and motor controller temp
    reading to teensy from gevcu to decrease # of msgs sent on bus
*/

// Define the CAN bus settings
FlexCAN_T4<CAN1, RX_SIZE_256, TX_SIZE_16> can1;

//speed, battery percetage, motor temp, motor controller temperature?
int i = 0;
int speed = 0;
int motor_temperature = 0;
int motor_controller_temperature = 0;
int battery_percentage = 0;
int state;
int BMS_PIN = 7;
int IMD_PIN = 8;
int RESET_PIN = 9;
int BMS_LED = 11;
int IMD_LED = 10;
int BUZZER_PIN = 4;
bool LED_ON = false;
int bms_fault = 0;
int imd_fault = 0;
// convention for CAN messages: source_dest_label
CAN_message_t dash_vcu_buzzPlayed;

// used to recieve the temp value
// you might need to change this in a fat
// if loop to sift through the messages
CAN_message_t incoming_message;

// LUT for motor temperature
static const struct {
    int32_t value;
    int16_t tempC;
} motorTempLookup[] = {
    {7414, -35}, {7687, -30}, {7962, -25}, {8240, -20}, {8520, -15},
    {8802, -10}, {9085, -5},  {9369,  0},  {9654,  5},  {9939, 10},
    {10225, 15}, {10510, 20}, {10795, 25}, {11080, 30}, {11364, 35},
    {11646, 40}, {11927, 45}, {12207, 50}, {12485, 55}, {12762, 60},
    {13036, 65}, {13308, 70}, {13578, 75}, {13846, 80}, {14111, 85},
    {14373, 90}, {14633, 95}, {14890, 100}, {15144, 105}, {15391, 110},
    {15632, 115}, {15852, 120}, {16061, 125}, {16251, 130}, {16421, 135},
    {16569, 140}, {16692, 145}, {16789, 150}, {16857, 155}
};

/************************************************
  motorToCelsius:
    Function to convert motor temp to celsius
  Args:
    reading (uint_16_t): first parameter
      raw hex bytes of the motor temperature msg
  Returns:
    double
************************************************/
int motorToCelsius(uint16_t reading) {
    for (int i = 1; i < (int)(sizeof(motorTempLookup) / sizeof(motorTempLookup[0])); ++i) {
        if (reading <= motorTempLookup[i].value) {
            double t1 = motorTempLookup[i-1].tempC;
            double t2 = motorTempLookup[i].tempC;
            double v1 = motorTempLookup[i-1].value;
            double v2 = motorTempLookup[i].value;

            double ratio = (reading - v1) / (v2 - v1);
            double result = t1 + ratio * (t2 - t1);
            return (int)result; // Truncate fractional part
        }
    }
    return (int)motorTempLookup[sizeof(motorTempLookup) / sizeof(motorTempLookup[0]) - 1].tempC;
}

// LUT for motor controller temperature
static const struct {
      int16_t tempC;
      uint16_t value;
  } controllerTempLookup[] = {
      { 125, 28480 }, { 120, 28179 }, { 115, 27851 }, { 110, 27497 },
      { 105, 27114 }, { 100, 26702 }, {  95, 26261 }, {  90, 25792 },
      {  85, 25296 }, {  80, 24775 }, {  75, 24232 }, {  70, 23671 },
      {  65, 23097 }, {  60, 22515 }, {  55, 21933 }, {  50, 21357 },
      {  45, 20793 }, {  40, 20250 }, {  35, 19733 }, {  30, 19247 },
      {  25, 18797 }, {  20, 18387 }, {  15, 18017 }, {  10, 17688 },
      {   5, 17400 }, {   0, 17151 }, {  -5, 16938 }, { -10, 16757 },
      { -15, 16609 }, { -20, 16487 }, { -25, 16387 }, { -30, 16308 }
  };

/************************************************
  motorControllerToCelsius:
    Function to convert motor controller temp to celsius
  Args:
    reading (uint_16_t): first parameter
      raw hex bytes of the motor controller temperature msg
  Returns:
    double
************************************************/
int motorControllerToCelsius(uint16_t reading) {
    for (int i = 1; i < (int)(sizeof(controllerTempLookup) / sizeof(controllerTempLookup[0])); ++i) {
        if (reading >= controllerTempLookup[i].value) {
            double t1 = controllerTempLookup[i-1].tempC;
            double t2 = controllerTempLookup[i].tempC;
            double v1 = controllerTempLookup[i-1].value;
            double v2 = controllerTempLookup[i].value;

            double ratio = (reading - v2) / (v1 - v2);
            double result = t2 + ratio * (t1 - t2);
            return (int)result; // Truncate fractional part
        }
    }
    return (int)controllerTempLookup[sizeof(controllerTempLookup) / sizeof(controllerTempLookup[0]) - 1].tempC;
}


int speedToMPH(uint16_t reading) {
    const int NMAX_IN_NDRIVE = 5000;
    const double gearRatio = 3.25;
    const int wheelDiameterInInches = 15;
    const double effeciency = 0.93;
    double percentage = (double) reading / 32767.0;
    double motorRPM = percentage * NMAX_IN_NDRIVE;
    double wheelRPM = motorRPM / gearRatio;
    double mph = (wheelRPM * 3.14159265359 * wheelDiameterInInches) / 1056.0 * effeciency;

    return (int)mph;
}

// CAN message from

void setup() {
  /*
    It should be known that Serial is the object for communication with the Serial Monitor function on the Arduino IDE.
    This Serial output can also be monitored using a python file.
    Please refer to the readTeensyOutputPython/main.py for more information.
  */
  Serial.begin(9600);

  // unsure if 14, 15 is serial3
  Serial3.begin(9600);    // RXTX

  // Can communication
  can1.begin();   // CAN communication
  can1.setBaudRate(500000);

  pinMode(BMS_PIN, INPUT);
  pinMode(IMD_PIN, INPUT);
  pinMode(RESET_PIN, INPUT);
  pinMode(13, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(BMS_LED, OUTPUT);
  digitalWrite(BMS_LED, HIGH);
  pinMode(IMD_LED, OUTPUT);
  digitalWrite(IMD_LED, HIGH);

  dash_vcu_buzzPlayed.id = 0x110;
  dash_vcu_buzzPlayed.buf[0] = 0x1;

  // added pin mode
}

void loop() {
  sendNumberToNextion("mtrtemp", motor_temperature);
  sendNumberToNextion("numbat", battery_percentage);
  sendNumberToNextion("probat", battery_percentage);
  sendNumberToNextion("numspeed", speed);
  sendNumberToNextion("mtrctrltemp", motor_controller_temperature);
  updateMotorTemperatureColor(motor_temperature);
  updateMotorControllerTemperatureColor(motor_controller_temperature);


  /*
    Check if received the buzzer message from VCU
    if so, then forward the state and call fxn:
    'sendResponse(blah,blah)'
  */
  if (can1.read(incoming_message)) {
    digitalWrite(13, LED_ON);
    LED_ON = !LED_ON;
    if (incoming_message.id == 0x109 && incoming_message.buf[0] == 0x1) {
      state = incoming_message.buf[1];
      buzz_played_response(state);


    } else if (incoming_message.id == 0x181){      //from the bamocar
      if (incoming_message.buf[0] == 0x30){// speed
        speed = decode_hex(incoming_message.buf[1], incoming_message.buf[2]);
        speed = speedToMPH(speed);
      }
      else if (incoming_message.buf[0] == 0x4a){                        // motor controller temp
      motor_controller_temperature = decode_hex(incoming_message.buf[1], incoming_message.buf[2]);
      motor_controller_temperature = (motorControllerToCelsius(motor_controller_temperature));
      } else if (incoming_message.buf[0] == 0x49){                        // motor temp
        motor_temperature = decode_hex(incoming_message.buf[1], incoming_message.buf[2]);
        motor_temperature = (motorToCelsius(motor_temperature));

      }
    } else if (incoming_message.id == 0x301) {
      battery_percentage = incoming_message.buf[4]/2;
    } else {                                                      // Errors from the Car to Display
      // switch (incoming_message.id){
      //   case 0x500: //PotBrake error messages
      //     sendPotbrakeError(incoming_message.buf[0]);
      //     break;
      //   case 0x501: //PotThrottle error messages
      //     break;
      // }
    }
  }

  if(!digitalRead(BMS_PIN)){
    bms_fault = 1;
  }

  if(bms_fault){
    digitalWrite(BMS_LED, LOW);
  }

  if(digitalRead(IMD_PIN)){
    imd_fault = 1;
  }

  if(imd_fault){
      digitalWrite(IMD_LED, LOW);
  }

  if(bms_fault){
    if(!digitalRead(RESET_PIN) && digitalRead(BMS_PIN)){
      bms_fault = 0;
      digitalWrite(BMS_LED, HIGH);
    }
  }

  if(imd_fault){
    if(!digitalRead(RESET_PIN) && !digitalRead(IMD_PIN)){
      imd_fault = 0;
      digitalWrite(IMD_LED, HIGH);
    }
  }

}
/************************************************
  decode_hex():
    celcius to farenheit
  Args:
    first_half  (int_64_t): first half of the bytes
    second_half (int_64_t): second half of the bytes
  Returns:
    float: gives back the farenheit value
************************************************/

int decode_hex( uint8_t first_half,  uint8_t second_half) {
    //second_half has 256 more weight since it is in the 2nd place of base 16, 16^2 = 256.
    return second_half * 256 + first_half;
}

/************************************************
  ctof():
    celcius to farenheit
  Args:
    c (int): celcius input
  Returns:
    float: gives back the farenheit value
************************************************/

int ctof (int c) {
  return floor(c*1.8 + 32);
}

/************************************************
  sendNumberToNextion():
    Function to send a number to a Nextion component

  Args:
    component (String): first parameter
      specify which component you are sending to
    value     (float) : second parameter
      value to show on display
  Returns:
    void
************************************************/

// Function to send a number to a Nextion component
void sendNumberToNextion(String component, int value) {
  // Send the command to update the text component with the value
  Serial3.print(component);
  Serial3.print(".val=");
  Serial3.print(value);
  sendEndCommand();
}

/************************************************
  buzz_played_response():
    Sends a message to the VCU that the buzzer has been played

  Args:
    state (int): first parameter
      takes the state of the recieved message and sends it back
  Returns:
    void
************************************************/
void buzz_played_response(int state) {
  dash_vcu_buzzPlayed.buf[1] = state;
  can1.write(dash_vcu_buzzPlayed); // some code to make buzz
  digitalWrite(BUZZER_PIN, HIGH);
  delay(3000);
  digitalWrite(BUZZER_PIN, LOW);
}


/*
Displays an error message for 3 seconds, before clearing
and displaying nothing.

  Args:
    msg (String): first parameter
        the message to display on the screen
  Returns:
    void

  Example msg: "Error:\\r\\nBMS TOO HOT"  (the \\r\\n is for a new line)
*/
void setErrorMessage(const String& msg) {
  Serial3.print("errormsg.txt=\\"" + msg + "\\"");
  sendEndCommand();
  Serial3.print("tm_errormsg.en=1"); // Enables the timer so that after 3 seconds it will stop displaying.
  sendEndCommand();
}

/*
  sendEndCommand():
    Function to send the end command required by Nextion Protocol

  Args:
    empty

  Returns:
    void
************************************************/

// Function to send the end command required by Nextion

void sendEndCommand() {
  Serial3.write(0xFF);
  Serial3.write(0xFF);
  Serial3.write(0xFF);
}

void updateMotorControllerTemperatureColor(int motor_controller_temperature){
  if (motor_controller_temperature > 85){ // RED
    Serial3.print("mtrctrltemp.pco=63488");
  }
  else if (motor_controller_temperature > 70){ // YELLOW
    Serial3.print("mtrctrltemp.pco=50688");
  }
  else if  (motor_controller_temperature > 60){ // Black
    Serial3.print("mtrctrltemp.pco=0");
  }
  sendEndCommand();
}

void updateMotorTemperatureColor(int motor_temperature){
  if (motor_temperature > 85){ // RED
    Serial3.print("mtrtemp.pco=63488");
  }
  else if (motor_temperature > 70){ // YELLOW
    Serial3.print("mtrtemp.pco=50688");
  }
  else if  (motor_temperature > 60){ // Black
    Serial3.print("mtrtemp.pco=0");
  }
  sendEndCommand();
}

void updateLights(){
  if (!digitalRead(BMS_PIN)){
      bms_fault = 1;
  }

  if (bms_fault){
      digitalWrite(BMS_LED, LOW);
  }

  if (digitalRead(IMD_PIN)){
      imd_fault = 1;
  }

  if (imd_fault){
      digitalWrite(IMD_LED, LOW);
  }

  if (bms_fault || imd_fault){
    if (!digitalRead(RESET_PIN) && digitalRead(BMS_PIN) && !digitalRead(IMD_PIN))
    {
      bms_fault = 0;
      imd_fault = 0;
      digitalWrite(BMS_LED, HIGH);
      digitalWrite(IMD_LED, HIGH);
    }
  }
}
            `
        }
    };

    // Click handling
    const mainContent = document.getElementById("mainContent");
    document.querySelectorAll(".toc a").forEach(link => {
        link.addEventListener("click", e => {
            e.preventDefault();
            const id = e.target.getAttribute("data-proj");
            const proj = projectDetails[id];
            if (proj) {
                mainContent.innerHTML = `
                    <h1>${proj.title}</h1>
                    ${proj.desc}
                    <div class="code-box">
                        <h2>Code Preview</h2>
                        <pre><code>${proj.code}</code></pre>
                    </div>
                `;
            }
        });
    });
</script>

</body>
</html>
